{% extends 'institute/base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="content-card">
    <h1 class="mb-4" style="color: #1e3a8a;">
        <i class="fas fa-credit-card me-2"></i>Add Expense
    </h1>

    <div class="row">
        <!-- Student Selection Section -->
        <div class="col-md-4 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-search me-2"></i>Select Student</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Search by Student Name, ID, or Mobile</label>
                        <input type="text" id="studentSearch" class="form-control"
                                placeholder="Enter student details..." autocomplete="off">
                        <small class="form-text text-muted">Type to search students</small>
                    </div>

                    <!-- Search Results -->
                    <div id="searchResults" class="list-group"
                        style="max-height: 300px; overflow-y: auto; display: none;">
                    </div>

                    <!-- Or Select -->
                    <div class="mt-3">
                        <label class="form-label">Or Select from List</label>
                        <select id="studentSelect" class="form-select" onchange="selectStudent()">
                            <option value="">-- Choose a student --</option>
                            {% for student in students %}
                            <option value="{{ student.id }}">
                                {{ student.admission_id }} - {{ student.student_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Selected Student Details -->
            <div id="studentDetails" style="display: none;" class="mt-4">
                <div class="card border-0 shadow-sm bg-light">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Selected Student</h5>
                    </div>
                    <div class="card-body">
                        <div id="studentPhoto" class="text-center mb-3"></div>
                        <p><strong>Name:</strong><br><span id="detailName"></span></p>
                        <p><strong>Admission ID:</strong><br><span id="detailAdmissionId"></span></p>
                        <p><strong>Mobile:</strong><br><span id="detailMobile"></span></p>
                        <p><strong>Course:</strong><br><span id="detailCourse"></span></p>
                        <p><strong>Total Fee:</strong><br>₹<span id="detailFee">0.00</span></p>
                        <p><strong>Total Paid:</strong><br>₹<span id="detailPaid">0.00</span></p>
                        <p><strong>Total Due:</strong><br><span class="text-danger">₹<span id="detailDue">0.00</span></span></p>

                        <button type="button" class="btn btn-warning btn-sm w-100 mt-3"
                                onclick="changeStudent()">
                            <i class="fas fa-sync me-1"></i>Change Student
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Form Section -->
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    {% if admission %}
                    <div id="paymentForm">
                    {% else %}
                    <div id="paymentForm" style="display: none;">
                    {% endif %}
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="admission_id"
                                    id="hiddenAdmissionId"
                                    value="{% if admission %}{{ admission.id }}{% endif %}">

                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.date|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.category|as_crispy_field }}
                                </div>
                                <div class="col-md-12">
                                    {{ form.amount|as_crispy_field }}
                                </div>
                                <div class="col-md-12">
                                    {{ form.description|as_crispy_field }}
                                </div>
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i> Record Expense 
                                </button>
                                {% if admission %}
                                <a href="{% url 'student_account' admission.id %}"
                                    class="btn btn-secondary ms-2">Cancel</a>
                                {% else %}
                                <button type="button" class="btn btn-secondary ms-2" onclick="changeStudent()">Cancel</button>
                                {% endif %}
                            </div>
                        </form>
                    </div>

                    {% if admission %}
                    <div id="selectStudentMessage" class="alert alert-info" style="display: none;">
                    {% else %}
                    <div id="selectStudentMessage" class="alert alert-info">
                    {% endif %}
                        <i class="fas fa-info-circle me-2"></i>
                        Please select a student first to record a payment.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
// Search functionality
document.getElementById('studentSearch').addEventListener('input', function(e) {
    const query = e.target.value.trim();
    const resultsDiv = document.getElementById('searchResults');
    
    if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    fetch(`/api/search-students/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            resultsDiv.innerHTML = '';
            if (data.results && data.results.length > 0) {
                data.results.forEach(student => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action cursor-pointer';
                    item.innerHTML = `
                        <strong>${student.admission_id}</strong> - ${student.student_name}<br>
                        <small class="text-muted">${student.course} | Mobile: ${student.mobile}</small>
                    `;
                    item.onclick = function(e) {
                        e.preventDefault();
                        selectStudentFromSearch(student);
                    };
                    resultsDiv.appendChild(item);
                });
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.innerHTML = '<div class="list-group-item text-muted">No students found</div>';
                resultsDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error searching students:', error);
            resultsDiv.innerHTML = '<div class="list-group-item text-danger">Error searching students</div>';
            resultsDiv.style.display = 'block';
        });
});

function selectStudentFromSearch(student) {
    displayStudentDetails(student);
    document.getElementById('hiddenAdmissionId').value = student.id;
    document.getElementById('paymentForm').style.display = 'block';
    document.getElementById('selectStudentMessage').style.display = 'none';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('studentSearch').value = '';
}

function selectStudent() {
    const id = document.getElementById('studentSelect').value;
    if (!id) {
        changeStudent();
        return;
    }

    fetch(`/api/get-student-details/${id}/`)
        .then(r => {
            if (!r.ok) {
                throw new Error('Network response was not ok');
            }
            return r.json();
        })
        .then(d => {
            if (d.success && d.data) {
                displayStudentDetails(d.data);
            } else if (d.results && d.results[0]) {
                // Fallback for old API format
                displayStudentDetails(d.results[0]);
            } else {
                throw new Error('Invalid student data format');
            }
            document.getElementById('hiddenAdmissionId').value = id;
            document.getElementById('paymentForm').style.display = 'block';
            document.getElementById('selectStudentMessage').style.display = 'none';
        })
        .catch(error => {
            console.error('Error fetching student details:', error);
            alert('Error loading student details. Please try again.');
        });
}

function displayStudentDetails(s) {
    document.getElementById('detailName').textContent = s.student_name || s.name || '';
    document.getElementById('detailAdmissionId').textContent = s.admission_id || '';
    document.getElementById('detailMobile').textContent = s.mobile || '';
    document.getElementById('detailCourse').textContent = s.course || '';
    document.getElementById('detailFee').textContent = parseFloat(s.total_fee || 0).toFixed(2);
    document.getElementById('detailPaid').textContent = parseFloat(s.total_payments || 0).toFixed(2);
    const due = parseFloat(s.total_fee || 0) - parseFloat(s.total_payments || 0);
    document.getElementById('detailDue').textContent = due.toFixed(2);
    document.getElementById('studentDetails').style.display = 'block';
}

function changeStudent() {
    document.getElementById('studentDetails').style.display = 'none';
    document.getElementById('studentSelect').value = '';
    document.getElementById('studentSearch').value = '';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('paymentForm').style.display = 'none';
    document.getElementById('selectStudentMessage').style.display = 'block';
    document.getElementById('hiddenAdmissionId').value = '';
}

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    const searchResults = document.getElementById('searchResults');
    const studentSearch = document.getElementById('studentSearch');
    
    if (!studentSearch.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = 'none';
    }
});
</script>

<style>
.cursor-pointer { cursor: pointer; }
#searchResults .list-group-item:hover {
    background-color: #f8f9fa !important;
}
.list-group-item {
    border-left: none;
    border-right: none;
}
.list-group-item:first-child {
    border-top: none;
}
</style>

{% endblock %}