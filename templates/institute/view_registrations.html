{% extends 'institute/base.html' %}

{% block content %}
<div class="content-card">
    <h1 class="mb-4" style="color: #1e3a8a;">
        <i class="fas fa-users me-2"></i>View Registrations
    </h1>
    
    <!-- Search Bar -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-10">
                    <input type="text" 
                            class="form-control" 
                            name="search" 
                            value="{{ search_query }}" 
                            placeholder="Search by name, mobile, admission ID...">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Registrations Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Admission ID</th>
                            <th>Student Name</th>
                            <th>Father's Name</th>
                            <th>Mobile</th>
                            <th>Course</th>
                            <th>Applied Date</th>
                            <th>Admitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for admission in admissions %}
                        <tr id="admission-row-{{ admission.id }}">
                            <td><span class="badge bg-primary">{{ admission.admission_id|default:"-" }}</span></td>
                            <td>{{ admission.student_name }}</td>
                            <td>{{ admission.father_name }}</td>
                            <td>{{ admission.mobile_number }}</td>
                            <td>{{ admission.course }}</td>
                            <td>{{ admission.created_at|date:"d/m/Y" }}</td>
                            <td>
                                <div class="form-check form-switch">
                                    {% if admission.has_transactions %}
                                        <!-- Show disabled checkbox with tooltip if student has transactions -->
                                        <input class="form-check-input admit-checkbox" 
                                                type="checkbox" 
                                                role="switch"
                                                data-admission-id="{{ admission.id }}" 
                                                {% if admission.is_admitted %}checked{% endif %}
                                                disabled
                                                title="Cannot change admission status - Student has transactions (payments/exams)">
                                        <span class="admit-badge">
                                            {% if admission.is_admitted %}
                                                <span class="badge bg-success">Yes</span>
                                            {% else %}
                                                <span class="badge bg-secondary">No</span>
                                            {% endif %}
                                        </span>
                                        <i class="fas fa-lock text-muted ms-1" 
                                            title="Locked due to existing transactions"></i>
                                    {% else %}
                                        <!-- Normal editable checkbox -->
                                        <input class="form-check-input admit-checkbox" 
                                                type="checkbox" 
                                                role="switch"
                                                data-admission-id="{{ admission.id }}" 
                                                {% if admission.is_admitted %}checked{% endif %}>
                                        <span class="admit-badge">
                                            {% if admission.is_admitted %}
                                                <span class="badge bg-success">Yes</span>
                                            {% else %}
                                                <span class="badge bg-secondary">No</span>
                                            {% endif %}
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <!-- View Details Button -->
                                <button type="button" 
                                        class="btn btn-sm btn-outline-info me-1 view-details-btn" 
                                        data-admission-id="{{ admission.id }}"
                                        title="View student details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                
                                <!-- Edit Button -->
                                <a href="{% url 'search_admission' %}?search={{ admission.admission_id|default:admission.mobile_number }}" 
                                    class="btn btn-sm btn-outline-warning me-1"
                                    title="Edit student information">
                                    <i class="fas fa-edit"></i>
                                </a>
                                
                                <!-- Delete Button - Conditional based on admission status and transactions -->
                                {% if not admission.is_admitted and not admission.has_transactions %}
                                <button type="button" 
                                        class="btn btn-sm btn-outline-danger delete-btn" 
                                        data-admission-id="{{ admission.id }}"
                                        data-student-name="{{ admission.student_name }}"
                                        title="Delete registration">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                {% elif admission.is_admitted %}
                                <!-- Show disabled delete button for admitted students -->
                                <button type="button" 
                                        class="btn btn-sm btn-outline-secondary" 
                                        disabled
                                        title="Cannot delete admitted students">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                {% elif admission.has_transactions %}
                                <!-- Show disabled delete button for students with transactions -->
                                <button type="button" 
                                        class="btn btn-sm btn-outline-secondary" 
                                        disabled
                                        title="Cannot delete - Student has transactions (payments/exams)">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No registrations found</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if admissions.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-3">
                <ul class="pagination justify-content-center">
                    {% if admissions.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ admissions.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for num in admissions.paginator.page_range %}
                        {% if admissions.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if admissions.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ admissions.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #1e3a8a; color: white;">
                <h5 class="modal-title" id="viewModalLabel">
                    <i class="fas fa-user-graduate me-2"></i>Student Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading student details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Close
                </button>
                <a href="#" class="btn btn-primary" id="editAdmissionBtn">
                    <i class="fas fa-edit me-1"></i> Edit Admission
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the registration for <strong id="deleteStudentName"></strong>?</p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash-alt me-1"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Warning Modal -->
<div class="modal fade" id="transactionWarningModal" tabindex="-1" aria-labelledby="transactionWarningModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="transactionWarningModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Cannot Change Status
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>This student has existing transactions (payments, expenses, or exam results).</p>
                <p class="mb-0"><strong>To change admission status:</strong></p>
                <ul class="mt-2">
                    <li>First delete all associated transactions</li>
                    <li>Or contact administrator for assistance</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>


<style>
    .modal-header {
        background: linear-gradient(135deg, #3960cc 0%, #3b82f6 100%);
    }
    
    .modal-content {
        border: none;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .btn-outline-info {
        border-color: #0dcaf0;
        color: #0dcaf0;
    }
    
    .btn-outline-info:hover {
        background-color: #0dcaf0;
        color: white;
    }
    
    .btn-outline-danger {
        border-color: #dc3545;
        color: #dc3545;
    }
    
    .btn-outline-danger:hover {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-outline-secondary {
        border-color: #6c757d;
        color: #6c757d;
        cursor: not-allowed;
        opacity: 0.65;
    }
    
    .btn-outline-secondary:hover {
        background-color: transparent;
        color: #6c757d;
    }
    
    .badge {
        font-size: 0.85em;
        padding: 0.35em 0.65em;
    }
    
    .table th {
        background-color: #f8f9fa;
        color: #1e3a8a;
        font-weight: 600;
    }
    
    .row-deleted {
        background-color: #f8d7da;
        transition: background-color 0.5s ease;
    }
    
    .form-check-input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .fa-lock {
        font-size: 0.8rem;
        opacity: 0.7;
    }
    
    [title] {
        cursor: help;
    }
    
    .detail-row {
        margin-bottom: 8px;
        padding: 4px 0;
        border-bottom: 1px dashed #e9ecef;
    }
    
    .detail-label {
        font-weight: 600;
        color: #495057;
    }
    
    .detail-value {
        color: #212529;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize modals
        const viewModal = new bootstrap.Modal(document.getElementById('viewModal'));
        const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        const transactionWarningModal = new bootstrap.Modal(document.getElementById('transactionWarningModal'));
        
        const modalBody = document.getElementById('modalBody');
        const editAdmissionBtn = document.getElementById('editAdmissionBtn');
        
        // Handle view details button clicks
        const viewButtons = document.querySelectorAll('.view-details-btn');
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const admissionId = this.getAttribute('data-admission-id');
                loadStudentDetails(admissionId);
                viewModal.show();
            });
        });
        
        // Handle delete button clicks - only for actual delete buttons, not disabled ones
        const deleteButtons = document.querySelectorAll('.delete-btn:not(.btn-outline-secondary)');
        let currentDeleteId = null;
        
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const admissionId = this.getAttribute('data-admission-id');
                const studentName = this.getAttribute('data-student-name');
                
                currentDeleteId = admissionId;
                document.getElementById('deleteStudentName').textContent = studentName;
                deleteConfirmModal.show();
            });
        });
        
        // Handle confirm delete button
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (currentDeleteId) {
                deleteRegistration(currentDeleteId);
            }
        });
        
        function loadStudentDetails(admissionId) {
            modalBody.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading student details...</p>
                </div>
            `;
            
            fetch(`/api/get-complete-admission-details/${admissionId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        displayCompleteDetails(data.admission);
                    } else {
                        modalBody.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error loading student details: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    modalBody.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading student details. Please try again.
                        </div>
                    `;
                });
        }
        
        function deleteRegistration(admissionId) {
            const csrftoken = getCookie('csrftoken');
            
            fetch(`/delete-registration/${admissionId}/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'HTTP ' + response.status);
                    }).catch(() => {
                        throw new Error('HTTP ' + response.status);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    // Close the delete confirmation modal
                    deleteConfirmModal.hide();
                    
                    // Show success message
                    showNotification('success', data.message || 'Registration deleted successfully');
                    
                    // Remove the row from the table with animation
                    const row = document.getElementById(`admission-row-${admissionId}`);
                    if (row) {
                        row.classList.add('row-deleted');
                        setTimeout(() => {
                            row.remove();
                            
                            // Check if table is empty and show message
                            const tbody = document.querySelector('tbody');
                            if (tbody.children.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4"><i class="fas fa-users fa-3x text-muted mb-3"></i><p class="text-muted">No registrations found</p></td></tr>';
                            }
                        }, 500);
                    }
                    
                    currentDeleteId = null;
                } else {
                    alert('Error: ' + (data && data.error ? data.error : 'Could not delete registration'));
                }
            })
            .catch(err => {
                console.error('Delete error:', err);
                alert('Error deleting registration: ' + (err.message || err));
                deleteConfirmModal.hide();
            });
        }
        
        function displayCompleteDetails(admission) {
            // Format date of birth
            let dobDisplay = 'Not provided';
            if (admission.date_of_birth) {
                const dob = new Date(admission.date_of_birth);
                dobDisplay = dob.toLocaleDateString('en-GB');
            }
            
            // Format dates
            const appliedDate = new Date(admission.created_at).toLocaleDateString('en-GB');
            
            // Create comprehensive modal content
            const modalContent = `
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <h5 class="text-center mb-4" style="color: #1e3a8a;">
                            THE MOTHER INSTITUTE OF SCIENCE<br>
                            <small class="text-muted">Excellence in Science Education</small>
                        </h5>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="border-bottom pb-2 mb-3" style="color: #1e3a8a;">
                            <i class="fas fa-user-circle me-2"></i>Personal Information
                        </h6>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Admission ID:</div>
                            <div class="col-8 detail-value">${admission.admission_id || 'Not assigned'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Student Name:</div>
                            <div class="col-8 detail-value">${admission.student_name || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Father's Name:</div>
                            <div class="col-8 detail-value">${admission.father_name || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Mother's Name:</div>
                            <div class="col-8 detail-value">${admission.mother_name || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Date of Birth:</div>
                            <div class="col-8 detail-value">${dobDisplay}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Mobile Number:</div>
                            <div class="col-8 detail-value">${admission.mobile_number || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">WhatsApp Number:</div>
                            <div class="col-8 detail-value">${admission.whatsapp_number || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Blood Group:</div>
                            <div class="col-8 detail-value">${admission.blood_group || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Category:</div>
                            <div class="col-8 detail-value">${admission.category || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Aadhaar Number:</div>
                            <div class="col-8 detail-value">${admission.adhaar_number || 'Not provided'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="border-bottom pb-2 mb-3" style="color: #1e3a8a;">
                            <i class="fas fa-graduation-cap me-2"></i>Academic Information
                        </h6>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Course:</div>
                            <div class="col-8 detail-value">${admission.course || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">College Name:</div>
                            <div class="col-8 detail-value">${admission.college_name || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Board Name:</div>
                            <div class="col-8 detail-value">${admission.board_name || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">College Roll No:</div>
                            <div class="col-8 detail-value">${admission.college_roll_no || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Batch:</div>
                            <div class="col-8 detail-value">${admission.batch || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">11th Year:</div>
                            <div class="col-8 detail-value">${admission.eleventh_year || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">12th Year:</div>
                            <div class="col-8 detail-value">${admission.twelfth_year || 'Not provided'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="border-bottom pb-2 mb-3" style="color: #1e3a8a;">
                            <i class="fas fa-book-open me-2"></i>Subject Details
                        </h6>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Subject 1:</div>
                            <div class="col-8 detail-value">${admission.subject1 || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Subject 2:</div>
                            <div class="col-8 detail-value">${admission.subject2 || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Subject 3:</div>
                            <div class="col-8 detail-value">${admission.subject3 || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Subject 4:</div>
                            <div class="col-8 detail-value">${admission.subject4 || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Subject 5:</div>
                            <div class="col-8 detail-value">${admission.subject5 || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Subject 6:</div>
                            <div class="col-8 detail-value">${admission.subject6 || 'Not provided'}</div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="border-bottom pb-2 mb-3" style="color: #1e3a8a;">
                            <i class="fas fa-file-alt me-2"></i>Enrollment Details
                        </h6>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Enrolled For:</div>
                            <div class="col-8 detail-value">${admission.enrolled_for || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">SAMS Login ID:</div>
                            <div class="col-8 detail-value">${admission.sams_login_id || 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">SAMS Password:</div>
                            <div class="col-8 detail-value">${admission.sams_password ? '••••••••' : 'Not provided'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">APAAR ID:</div>
                            <div class="col-8 detail-value">${admission.apaar_id || 'Not provided'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="border-bottom pb-2 mb-3" style="color: #1e3a8a;">
                            <i class="fas fa-money-bill-wave me-2"></i>Fees Details
                        </h6>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">Hostel Fees:</div>
                            <div class="col-8 detail-value">₹${admission.hostel_fees || '0.00'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">TMS Fees:</div>
                            <div class="col-8 detail-value">₹${admission.tms_fees || '0.00'}</div>
                        </div>
                        <div class="row detail-row">
                            <div class="col-4 detail-label">College Fees:</div>
                            <div class="col-8 detail-value">₹${admission.admitted_college_fees || '0.00'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="border-bottom pb-2 mb-3" style="color: #1e3a8a;">
                            <i class="fas fa-home me-2"></i>Address
                        </h6>
                        <div class="row">
                            <div class="col-12">
                                <p>${admission.address || 'Not provided'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Applied Date and Status -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Applied Date:</strong> ${appliedDate}
                                </div>
                                <div class="col-md-6">
                                    <strong>Admitted Status:</strong> 
                                    <span class="badge bg-${admission.is_admitted ? 'success' : 'secondary'}">
                                        ${admission.is_admitted ? 'Yes' : 'No'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modalBody.innerHTML = modalContent;
            editAdmissionBtn.href = `/search-admission/?admission_id=${admission.id}`;
        }
        
        // CSRF helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Notification helper
        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            notification.style.zIndex = '9999';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Handle admit checkbox toggles - only for enabled checkboxes
        const admitCheckboxes = document.querySelectorAll('.admit-checkbox:not(:disabled)');
        
        admitCheckboxes.forEach(cb => {
            cb.addEventListener('change', function(e) {
                const admissionId = this.getAttribute('data-admission-id');
                const isChecked = this.checked;
                const csrftoken = getCookie('csrftoken');
                
                // Show confirmation dialog
                if (!confirm(`Are you sure you want to ${isChecked ? 'admit' : 'remove admission for'} this student?`)) {
                    this.checked = !isChecked; // Revert the checkbox
                    return;
                }

                fetch(`/toggle-admit/${admissionId}/`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ 'is_admitted': isChecked })
                })
                .then(resp => {
                    if (!resp.ok) {
                        return resp.json().then(data => {
                            throw new Error(data.error || 'HTTP ' + resp.status);
                        });
                    }
                    return resp.json();
                })
                .then(data => {
                    if (data && data.success) {
                        const badgeSpan = cb.closest('td').querySelector('.admit-badge');
                        if (data.is_admitted) {
                            badgeSpan.innerHTML = '<span class="badge bg-success">Yes</span>';
                            showNotification('success', 'Student admitted successfully!');
                        } else {
                            badgeSpan.innerHTML = '<span class="badge bg-secondary">No</span>';
                            showNotification('success', 'Student admission removed!');
                        }
                        
                        // Refresh the page after a short delay to update delete buttons
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        alert('Error: ' + (data && data.error ? data.error : 'Could not update status'));
                        cb.checked = !isChecked;
                    }
                })
                .catch(err => {
                    console.error('Admit toggle error:', err);
                    
                    // Check if error is due to transactions
                    if (err.message && err.message.includes('transactions')) {
                        transactionWarningModal.show();
                    } else {
                        alert('Error updating admitted status: ' + (err.message || err));
                    }
                    
                    cb.checked = !isChecked;
                });
            });
        });
        
        // Add tooltips to all elements with title attribute
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
        tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}